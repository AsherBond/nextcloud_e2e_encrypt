{"version":3,"file":"end_to_end_encryption-settings.mjs","sources":["../node_modules/vue-material-design-icons/Close.vue","../src/components/SecuritySection.vue","../src/settings.js"],"sourcesContent":["<template>\n  <span v-bind=\"$attrs\"\n        :aria-hidden=\"title ? null : 'true'\"\n        :aria-label=\"title\"\n        class=\"material-design-icon close-icon\"\n        role=\"img\"\n        @click=\"$emit('click', $event)\">\n    <svg :fill=\"fillColor\"\n         class=\"material-design-icon__svg\"\n         :width=\"size\"\n         :height=\"size\"\n         viewBox=\"0 0 24 24\">\n      <path d=\"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z\">\n        <title v-if=\"title\">{{ title }}</title>\n      </path>\n    </svg>\n  </span>\n</template>\n\n<script>\nexport default {\n  name: \"CloseIcon\",\n  emits: ['click'],\n  props: {\n    title: {\n      type: String,\n    },\n    fillColor: {\n      type: String,\n      default: \"currentColor\"\n    },\n    size: {\n      type: Number,\n      default: 24\n    }\n  }\n}\n</script>","<!--\n  - SPDX-FileCopyrightText: 2022 Carl Schwan <carl@carlschwan.eu>\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n  -->\n\n<template>\n\t<NcSettingsSection :name=\"t('end_to_end_encryption', 'End-to-end encryption')\"\n\t\t:description=\"encryptionState\">\n\t\t<NcButton v-if=\"!shouldDisplayE2EEInBrowserWarning && userConfig['e2eeInBrowserEnabled'] === false\"\n\t\t\tclass=\"margin-bottom\"\n\t\t\t:disabled=\"!hasKey\"\n\t\t\ttype=\"secondary\"\n\t\t\t@click=\"shouldDisplayE2EEInBrowserWarning = true\">\n\t\t\t{{ t('end_to_end_encryption', 'Enable E2EE navigation in browser') }}\n\t\t</NcButton>\n\t\t<NcNoteCard v-else\n\t\t\tclass=\"notecard\"\n\t\t\ttype=\"warning\"\n\t\t\t:show-alert=\"true\"\n\t\t\t:heading=\"t('end_to_end_encryption', 'Enabling E2EE in the browser can weaken security')\">\n\t\t\t<NcButton v-if=\"userConfig['e2eeInBrowserEnabled'] === false\"\n\t\t\t\tclass=\"close-button\"\n\t\t\t\t:aria-label=\"t('end_to_end_encryption', 'Close')\"\n\t\t\t\ttype=\"tertiary-no-background\"\n\t\t\t\t@click=\"shouldDisplayE2EEInBrowserWarning = false\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<IconClose :size=\"20\" />\n\t\t\t\t</template>\n\t\t\t</NcButton>\n\n\t\t\t{{ t('end_to_end_encryption', 'The server could serve malicious source code to extract the secret that protects your files.') }}\n\n\t\t\t<NcCheckboxRadioSwitch :disabled=\"!hasKey\"\n\t\t\t\tdata-cy-e2ee-settings-setting=\"e2ee_in_browser_enabled\"\n\t\t\t\t:checked=\"userConfig.e2eeInBrowserEnabled\"\n\t\t\t\tclass=\"margin-bottom\"\n\t\t\t\ttype=\"switch\"\n\t\t\t\t@update:checked=\"value => setConfig('e2eeInBrowserEnabled', value)\">\n\t\t\t\t{{ t('end_to_end_encryption', 'Enable E2EE navigation in browser') }}\n\t\t\t</NcCheckboxRadioSwitch>\n\t\t</NcNoteCard>\n\n\t\t<NcButton v-if=\"!shouldDisplayWarning\"\n\t\t\t:disabled=\"!hasKey\"\n\t\t\t:type=\"(hasKey && !shouldDisplayWarning) ? 'error' : 'secondary'\"\n\t\t\t@click=\"startResetProcess()\">\n\t\t\t{{ t('end_to_end_encryption', 'Reset end-to-end encryption') }}\n\t\t</NcButton>\n\t\t<NcNoteCard v-else\n\t\t\tclass=\"notecard\"\n\t\t\ttype=\"warning\"\n\t\t\t:show-alert=\"true\"\n\t\t\t:heading=\"t('end_to_end_encryption', 'Please read carefully before resetting your end-to-end encryption keys')\">\n\t\t\t<NcButton class=\"close-button\"\n\t\t\t\t:aria-label=\"t('end_to_end_encryption', 'Close')\"\n\t\t\t\ttype=\"tertiary-no-background\"\n\t\t\t\t@click=\"shouldDisplayWarning = false\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<IconClose :size=\"20\" />\n\t\t\t\t</template>\n\t\t\t</NcButton>\n\n\t\t\t<ul>\n\t\t\t\t<li>{{ t('end_to_end_encryption', 'Once your end-to-end encryption keys are reset, all files stored in your encrypted folder will be inaccessible.') }}</li>\n\t\t\t\t<li>{{ t('end_to_end_encryption', 'You should only reset your end-to-end encryption keys if you lost your secure key words (mnemonic).') }}</li>\n\t\t\t\t<li>{{ t('end_to_end_encryption', 'Check on all connected devices if you can retrieve your mnemonic.') }}</li>\n\t\t\t\t<li>{{ t('end_to_end_encryption', 'Any still connected device might cause problems after deleting the keys, so it is better to disconnect and reconnect the devices again.') }}</li>\n\t\t\t</ul>\n\n\t\t\t<NcCheckboxRadioSwitch :checked.sync=\"deleteEncryptedFiles\" type=\"switch\" class=\"margin-bottom\">\n\t\t\t\t{{ t('end_to_end_encryption', 'Delete existing encrypted files') }}\n\t\t\t</NcCheckboxRadioSwitch>\n\n\t\t\t<NcButton type=\"error\" @click=\"showDialog\">\n\t\t\t\t{{ t('end_to_end_encryption', \"Confirm and reset end-to-end encryption\") }}\n\t\t\t</NcButton>\n\t\t</NcNoteCard>\n\t</NcSettingsSection>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport IconClose from 'vue-material-design-icons/Close.vue'\n\nimport axios from '@nextcloud/axios'\nimport { translate as t } from '@nextcloud/l10n'\nimport NcSettingsSection from '@nextcloud/vue/dist/Components/NcSettingsSection.js'\nimport NcCheckboxRadioSwitch from '@nextcloud/vue/dist/Components/NcCheckboxRadioSwitch.js'\nimport NcButton from '@nextcloud/vue/dist/Components/NcButton.js'\nimport NcNoteCard from '@nextcloud/vue/dist/Components/NcNoteCard.js'\nimport { loadState } from '@nextcloud/initial-state'\nimport { showError, showSuccess, DialogBuilder } from '@nextcloud/dialogs'\nimport { generateOcsUrl, generateUrl } from '@nextcloud/router'\n\nimport logger from '../services/logger.js'\n\nexport default defineComponent({\n\tname: 'SecuritySection',\n\tcomponents: {\n\t\tNcSettingsSection,\n\t\tNcButton,\n\t\tNcCheckboxRadioSwitch,\n\t\tNcNoteCard,\n\t\tIconClose,\n\t},\n\n\tdata() {\n\t\treturn {\n\t\t\thasKey: loadState('end_to_end_encryption', 'hasKey'),\n\t\t\tshouldDisplayWarning: false,\n\t\t\tdeleteEncryptedFiles: false,\n\t\t\tshouldDisplayE2EEInBrowserWarning: false,\n\t\t\tuserConfig: loadState('end_to_end_encryption', 'userConfig', { e2eeInBrowserEnabled: false }),\n\t\t}\n\t},\n\n\tcomputed: {\n\t\tconfirmationDialog() {\n\t\t\tconst builder = new DialogBuilder()\n\t\t\treturn builder\n\t\t\t\t.setName(t('end_to_end_encryption', 'Confirm resetting keys'))\n\t\t\t\t.setText(t('end_to_end_encryption', 'This is the final warning: Do you really want to reset your keys?'))\n\t\t\t\t.addButton({\n\t\t\t\t\tlabel: t('end_to_end_encryption', 'Cancel'),\n\t\t\t\t\ttype: 'tertiary',\n\t\t\t\t\tcallback: () => {\n\t\t\t\t\t\tthis.deleteEncryptedFiles = false\n\t\t\t\t\t\tthis.shouldDisplayWarning = false\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t\t.addButton({\n\t\t\t\t\tlabel: t('end_to_end_encryption', 'Reset keys'),\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tcallback: this.resetEncryption.bind(this),\n\t\t\t\t})\n\t\t\t\t.build()\n\t\t},\n\t\tencryptionState() {\n\t\t\tif (this.hasKey) {\n\t\t\t\treturn t(\n\t\t\t\t\t'end_to_end_encryption',\n\t\t\t\t\t'End-to-end encryption is currently enabled and correctly setup.',\n\t\t\t\t)\n\t\t\t} else {\n\t\t\t\treturn t(\n\t\t\t\t\t'end_to_end_encryption',\n\t\t\t\t\t'End-to-end encryption is currently disabled. You can set it up with the {productName} clients.',\n\t\t\t\t\t{\n\t\t\t\t\t\tproductName: OCA.Theming\n\t\t\t\t\t\t\t? OCA.Theming.name\n\t\t\t\t\t\t\t: 'Nextcloud',\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t}\n\t\t},\n\t},\n\tmethods: {\n\t\tshowDialog() {\n\t\t\tthis.confirmationDialog\n\t\t\t\t.show()\n\t\t},\n\t\tstartResetProcess() {\n\t\t\tthis.shouldDisplayWarning = true\n\t\t},\n\t\tasync deletePrivateKey() {\n\t\t\tconst { data } = await axios.delete(\n\t\t\t\tgenerateOcsUrl('/apps/end_to_end_encryption/api/v1/private-key'),\n\t\t\t)\n\n\t\t\treturn this.handleResponse({\n\t\t\t\tstatus: data.ocs?.meta?.status,\n\t\t\t\terror: null,\n\t\t\t})\n\t\t},\n\t\tasync deletePublicKey() {\n\t\t\tconst { data } = await axios.delete(\n\t\t\t\tgenerateOcsUrl('/apps/end_to_end_encryption/api/v1/public-key'),\n\t\t\t)\n\n\t\t\treturn this.handleResponse({\n\t\t\t\tstatus: data.ocs?.meta?.status,\n\t\t\t\terror: null,\n\t\t\t})\n\t\t},\n\t\tasync deleteFiles() {\n\t\t\tif (this.deleteEncryptedFiles) {\n\t\t\t\tconst { data } = await axios.delete(\n\t\t\t\t\tgenerateOcsUrl(\n\t\t\t\t\t\t'/apps/end_to_end_encryption/api/v1/encrypted-files',\n\t\t\t\t\t),\n\t\t\t\t)\n\n\t\t\t\treturn this.handleResponse({\n\t\t\t\t\tstatus: data.ocs?.meta?.status,\n\t\t\t\t\terror: null,\n\t\t\t\t})\n\t\t\t}\n\t\t\treturn true\n\t\t},\n\t\tasync resetEncryption() {\n\t\t\ttry {\n\t\t\t\tlet success = true\n\t\t\t\tsuccess = success && (await this.deletePrivateKey())\n\t\t\t\tsuccess = success && (await this.deletePublicKey())\n\t\t\t\tsuccess = success && (await this.deleteFiles())\n\n\t\t\t\tif (success) {\n\t\t\t\t\tshowSuccess(\n\t\t\t\t\t\tt(\n\t\t\t\t\t\t\t'end_to_end_encryption',\n\t\t\t\t\t\t\t'End-to-end encryption keys reset',\n\t\t\t\t\t\t),\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tthis.handleResponse({\n\t\t\t\t\terrorMessage: t(\n\t\t\t\t\t\t'end_to_end_encryption',\n\t\t\t\t\t\t'Unable to reset end-to-end encryption',\n\t\t\t\t\t),\n\t\t\t\t\terror: e,\n\t\t\t\t})\n\t\t\t} finally {\n\t\t\t\tthis.shouldDisplayWarning = false\n\t\t\t\tthis.hasKey = false\n\t\t\t}\n\t\t},\n\t\tasync handleResponse({ status, errorMessage, error }) {\n\t\t\tif (status !== 'ok') {\n\t\t\t\tshowError(errorMessage)\n\t\t\t\tlogger.error(errorMessage, { error })\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t},\n\n\t\tasync setConfig(key: string, value: string) {\n\t\t\tawait axios.put(generateUrl('apps/end_to_end_encryption/api/v1/config/{key}', { key }), {\n\t\t\t\tvalue: (typeof value === 'string') ? value : JSON.stringify(value),\n\t\t\t})\n\t\t\tthis.userConfig[key] = value\n\t\t},\n\n\t\tt,\n\t},\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.notecard {\n\tposition: relative;\n\n\t.close-button {\n\t\tposition: absolute;\n\t\ttop: 0;\n\t\tright: 0;\n\t}\n}\n\nli {\n\tlist-style-type: initial;\n\tmargin-left: 1rem;\n\tpadding: 0.25rem 0;\n}\n\n.margin-bottom {\n\tmargin-bottom: 0.75rem;\n}\n\n.modal-container {\n\tpadding: 16px;\n\tbutton {\n\t\tmargin-top: 16px;\n\t\tmargin-left: 8px;\n\t}\n}\n\n.button-row {\n\tdisplay: flex;\n\tjustify-content: end;\n}\n</style>\n","/**\n * SPDX-FileCopyrightText: 2022 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport Vue from 'vue'\nimport { translate, translatePlural } from '@nextcloud/l10n'\n\nimport SecuritySection from './components/SecuritySection.vue'\n\nVue.prototype.t = translate\nVue.prototype.n = translatePlural\n\nconst View = Vue.extend(SecuritySection)\nnew View({}).$mount('#security-end-to-end')\n"],"names":["_sfc_main","t","axios","generateOcsUrl","generateUrl"],"mappings":"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","x_google_ignoreList":[0]}